<!DOCTYPE html>
<html>
  <head>
    
    <title>react-native-image-picker - 阮旭松的博客</title>
    <meta charset="UTF-8" />
    <meta name="description" content="基于hexo的博客" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
     

    <link
      rel="shortcut icon"
      href="/favicon.ico"
      type="image/x-icon"
    />
    <meta name="description" content="react-native-image-picker实战，实现图片上传">
<meta property="og:type" content="article">
<meta property="og:title" content="react-native-image-picker">
<meta property="og:url" content="https://www.ruanxusong.com/2020/01/23/rnImagePicker/index.html">
<meta property="og:site_name" content="阮旭松的博客">
<meta property="og:description" content="react-native-image-picker实战，实现图片上传">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.ruanxusong.com/images/posts/rnImagePicker/ios-result.jpg">
<meta property="og:image" content="https://www.ruanxusong.com/images/posts/rnImagePicker/android-result.jpg">
<meta property="article:published_time" content="2020-01-23T03:16:32.000Z">
<meta property="article:modified_time" content="2020-01-23T05:42:12.418Z">
<meta property="article:author" content="Ruan XuSong">
<meta property="article:tag" content="react-native">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.ruanxusong.com/images/posts/rnImagePicker/ios-result.jpg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/css/mdui.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.15.8/styles/atom-one-dark.css" />
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
     
    <link
      rel="stylesheet"
      href="//at.alicdn.com/t/font_1038733_0xvrvpg9c0r.css"
    />
    <link rel="stylesheet" href="/css/style.css?v=1579758438473">
  <meta name="generator" content="Hexo 4.2.0"></head>

  <body class="mdui-drawer-body-left">
    
    <div id="nexmoe-background">
      <div
        class="nexmoe-bg"
        style="background-image: url(/images/background.jpeg)"
      ></div>
      <div class="mdui-appbar mdui-shadow-0">
        <div class="mdui-toolbar">
          <a
            mdui-drawer="{target: '#drawer', swipe: true}"
            title="menu"
            class="mdui-btn mdui-btn-icon"
            ><i class="mdui-icon material-icons">menu</i></a
          >
          <div class="mdui-toolbar-spacer"></div>
          <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
          <a
            href="/"
            title="Ruan XuSong"
            class="mdui-btn mdui-btn-icon"
            ><img src="/images/avatar.jpeg"
          /></a>
        </div>
      </div>
    </div>
    <div id="nexmoe-header">
      <div class="nexmoe-drawer mdui-drawer" id="drawer">
  <div class="nexmoe-avatar mdui-ripple">
    <a href="/" title="Ruan XuSong">
      <img
        src="/images/avatar.jpeg"
        alt="Ruan XuSong"
      />
    </a>
  </div>
  <div class="nexmoe-count">
    <div><span>文章</span>7</div>
    <div><span>标签</span>6</div>
    <div>
      <span>分类</span>2
    </div>
  </div>
  <ul class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
    
    <a
      class="nexmoe-list-item mdui-list-item mdui-ripple"
      href="/"
      title="回到首页"
    >
      <i
        class="mdui-list-item-icon nexmoefont icon-home"
      ></i>
      <div class="mdui-list-item-content">
        回到首页
      </div>
    </a>
    
    <a
      class="nexmoe-list-item mdui-list-item mdui-ripple"
      href="/about.html"
      title="关于博客"
    >
      <i
        class="mdui-list-item-icon nexmoefont icon-info-circle"
      ></i>
      <div class="mdui-list-item-content">
        关于博客
      </div>
    </a>
    
    <a
      class="nexmoe-list-item mdui-list-item mdui-ripple"
      href="/photoWall/index.html"
      title="照片墙"
    >
      <i
        class="mdui-list-item-icon nexmoefont icon-appstore-fill"
      ></i>
      <div class="mdui-list-item-content">
        照片墙
      </div>
    </a>
    
  </ul>
  <aside id="nexmoe-sidebar">
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">社交按钮</h3>
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="http://wpa.qq.com/msgrd?v=3&uin=920595664&site=qq&menu=yes" target="_blank" mdui-tooltip="{content: 'QQ'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-QQ"></i>
        </a><a class="mdui-ripple" href="https://github.com/ruanxusong/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/tech/">技术</a>
          <span class="category-list-count">6</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/life/">生活</a>
          <span class="category-list-count">1</span>
        </li>

        
      </ul>

    </div>
  </div>


  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">标签云</h3>
    <div id="randomtagcloud" class="nexmoe-widget tagcloud">
      <a href="/tags/ES6/" style="font-size: 10px;">ES6</a> <a href="/tags/react-native/" style="font-size: 20px;">react-native</a> <a href="/tags/three/" style="font-size: 10px;">three.js</a> <a href="/tags/motion/" style="font-size: 10px;">心情</a> <a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 10px;">正则</a> <a href="/tags/%E6%B2%B9%E7%8C%B4/" style="font-size: 10px;">油猴</a>
    </div>
    
  </div>

  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章归档</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li></ul>
    </div>
  </div>


  
</aside>
  <div class="nexmoe-copyright">
    &copy; 2020 Ruan XuSong
  </div>
</div>
<!-- .nexmoe-drawer -->

    </div>
    <div id="nexmoe-content">
      <div class="nexmoe-primary">
        <div class="nexmoe-post">
    <div class="nexmoe-post-cover"> 
        
        <img src="/covers/rnImagePicker.jpg">
        
        <h1>react-native-image-picker</h1>
    </div>
  <div class="nexmoe-post-meta">
    <a><i class="nexmoefont icon-calendar-fill"></i>2020年01月23日</a>
    <a><i class="nexmoefont icon-areachart"></i>1.3k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 6 分钟</a>
    
      <a class="nexmoefont icon-appstore-fill -link" href="/categories/tech/">技术</a>
    
    
      <a class="nexmoefont icon-tag-fill -link" href="/tags/react-native/" rel="tag">react-native</a>
    
  </div>
  <article>
    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>&emsp;&emsp;图片上传的功能在手机 APP 上用的也是很多了，今天主要讲一下怎么用<code>react-native-image-picker</code>具体实现安卓和 IOS 上的图片上传并解决一些常见问题。本文还会涉及<code>rn-fetch-blob</code>上传插件。</p>
<h2 id="React-Native-Image-Picker"><a href="#React-Native-Image-Picker" class="headerlink" title="React Native Image Picker"></a>React Native Image Picker</h2><p>&emsp;&emsp;首先介绍一下<code>react-native-image-picker</code>是什么，官网上的解释：是一个可以让你用原生 UI 的形式选择手机上的图片、视频或者直接拍照的方式来上传文件的<code>React Native</code>的组件。但他只是帮我们完成了从手机里拿到照片的那一步，至于如何展示，上传还是需要我们自己实现。</p>
<h2 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h2><ul>
<li>1.我们需要写一个照片上传的容器来展示图片，抽组件。</li>
<li>2.引入<code>react-native-image-picker</code>完成图片获取，上传成功后将 source 放到写好的容器中。</li>
<li>3.上传成功后执行上传，调用文件服务的上传接口，这里用到了<code>rn-fetch-blob</code>插件。</li>
<li>4.最后是 ios 端的照片权限兼容。</li>
</ul>
<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><h3 id="图片容器"><a href="#图片容器" class="headerlink" title="图片容器"></a>图片容器</h3><p>&emsp;&emsp;首先是写一个照片上传的容器来展示图片,这里我写了一个<code>CustomImagePicker</code>的组件，<code>CustomImagePickerProps</code>中调用的时候要传入的属性：</p>
<pre><code class="typeScript">import React, { useState } from &#39;react&#39;;
import { Text, StyleSheet, Image, ImageBackground, TouchableOpacity, ImageSourcePropType } from &#39;react-native&#39;;
import { Colors, Size } from &#39;@/config&#39;;

/** 初始化自定义配置 */
const initialImageOptions: Options = {
  title: &#39;选择图片&#39;,
  storageOptions: {
    skipBackup: true,
    path: &#39;images&#39;,
  },
  mediaType: &#39;photo&#39;,
  chooseFromLibraryButtonTitle: &#39;图片库&#39;,
  cancelButtonTitle: &#39;取消&#39;,
  takePhotoButtonTitle: &#39;拍照&#39;,
};

interface CustomImagePickerProps {
  /** 初始化背景图 */
  imgSource?: ImageSourcePropType;
  /** 其他图片自定义配置,详细参考react-native-image-picker的option配置 */
  imgConfig?: Options;
  /** 悬浮文字 */
  title?: string;
  /** 取消事件回调 */
  onCancel?: (response: Response) =&gt; void;
  /** 失败事件回调 */
  onFailed?: (response: Response) =&gt; void;
  /** 成功事件回调,返回文件路径 */
  onSuccess?: (fileUrl: string) =&gt; void;
}
const CustomImagePicker: React.FC&lt;CustomImagePickerProps&gt; = props =&gt; {
  const { imgSource = require(&#39;@/assets/pic_empty.png&#39;), title = &#39;&#39;, imgConfig, onCancel, onFailed, onSuccess } = props;
  const imagePickerOptions = { ...initialImageOptions, ...imgConfig };
  const [currentImgSource, setCurrentImgSource] = useState();

return(
  const [currentImgSource, setCurrentImgSource] = useState();
   &lt;TouchableOpacity onPress={handleUploadImage}&gt;
      &lt;ImageBackground source={currentImgSource || imgSource} style={styles.backgroundImg}&gt;
        {!currentImgSource &amp;&amp; (
          &lt;&gt;
            &lt;Image source={require(&#39;@/assets/add-upload.png&#39;)} style={styles.addImg}&gt;&lt;/Image&gt;
            &lt;Text style={styles.titleText}&gt;{title}&lt;/Text&gt;
          &lt;/&gt;
        )}
      &lt;/ImageBackground&gt;
    &lt;/TouchableOpacity&gt;
    )
  }

// 样式部分
const styles = StyleSheet.create({
  backgroundImg: {
    width: px(277),
    height: px(152),
    marginLeft: px(28),
    zIndex: 0,
  },
  addImg: {
    width: px(64),
    height: px(64),
    marginTop: px(33),
    marginLeft: px(110),
  },
  titleText: {
    fontSize: px(15),
    color: Colors.grey,
    marginTop: px(19),
    textAlign: &#39;center&#39;,
  },
});</code></pre>
<p>&emsp;&emsp;需要用到<code>TouchableOpacity</code>来触发图片的上传操作，<code>ImageBackground</code>用来展示<code>imagePicker</code>拿到的图片，<code>currentImgSource</code>是当前选中的图片<code>source</code>。这样最基本的组件结构已经有了。</p>
<h3 id="引入-ImagePicker-回调方法"><a href="#引入-ImagePicker-回调方法" class="headerlink" title="引入 ImagePicker 回调方法"></a>引入 ImagePicker 回调方法</h3><p>&emsp;&emsp;接下来就是点击<code>TouchableOpacity</code>以后调用<code>ImagePicker</code>的<code>showImagePicker</code>的 API 拿到本地图片的地址<code>uri</code>,文件名称<code>fileName</code>,文件类型<code>type</code>并作为参数上传文件。<code>imagePickerOptions</code>是图片上传弹窗的基本配置。</p>
<pre><code class="typeScript">import ImagePicker from &#39;react-native-image-picker&#39;;

  /** ImagePicker上传调用 */
  const handleUploadImage = () =&gt; {
    ImagePicker.showImagePicker(imagePickerOptions, async response =&gt; {
      if (response.didCancel) {
        // 用户取消上传 回调
        onCancel &amp;&amp; onCancel(response);
      } else if (response.error) {
        // 上传失败 回调
        onFailed &amp;&amp; onFailed(response);
      } else {
        const source = { uri: response.uri };
        const file = {
          fileName: response.fileName!,
          fileType: response.type!,
          uri: response.uri,
        };
        // 上传成功 回调
        const uploadResult = await uploadFile(file);
        if (uploadResult.success) {
          setCurrentImgSource(source);
          onSuccess &amp;&amp; onSuccess(uploadResult.file);
        } else {
          toastFail(&#39;上传失败&#39;);
        }
      }
    });
  };</code></pre>
<h3 id="图片上传"><a href="#图片上传" class="headerlink" title="图片上传"></a>图片上传</h3><p>&emsp;&emsp;图片上传因为传统的 postForm 的上传方式后台无法接受到文件参数，用了<code>formData.append</code>效果也不太理想。最后用了<code>rn-fetch-blob</code>插件完美解决，<code>rn-fetch-blob</code>是一个用于简化文件上传的插件，具体可看官网: <a href="https://www.npmjs.com/package/rn-fetch-blob" target="_blank" rel="noopener">rn-fetch-blob</a>。图片上传逻辑如下：</p>
<pre><code class="typeScript">import RNFetchBlob from &#39;rn-fetch-blob&#39;;

  /** 上传文件 */
  const uploadFile = async ({ fileName, fileType, uri }: { fileName: string; fileType: string; uri: string }) =&gt; {
    try {
      const resultData = await RNFetchBlob.fetch(
        &#39;POST&#39;,
        `${UPLOAD_URL}/upload/public?access_token=${UPLOAD_TOKEN}`,
        {
          &#39;Content-Type&#39;: &#39;multipart/form-data&#39;,
        },
        [
          {
            name: &#39;file&#39;,
            filename: fileName,
            type: fileType,
            data: RNFetchBlob.wrap(uri.replace(&#39;file://&#39;, &#39;&#39;)),
          },
        ],
      );
      const result = resultData.json();
      if (!result.success) {
        toastFail(result.message);
      }
      return {
        success: result.success,
        file: result.data || &#39;&#39;,
      };
    } catch (error) {
      if (error.message) {
        toastFail(error.message);
      }
      return {
        success: false,
        file: &#39;&#39;,
      };
    }
  };</code></pre>
<p>&emsp;&emsp;其中<code>UPLOAD_URL</code>是文件服务的地址，<code>UPLOAD_TOKEN</code>是文件上传需要的 <code>accessToken</code>。</p>
<h3 id="rn-fetch-blob-的一些问题"><a href="#rn-fetch-blob-的一些问题" class="headerlink" title="rn-fetch-blob 的一些问题"></a>rn-fetch-blob 的一些问题</h3><ul>
<li><p>Q:<code>rn-fetch-blob</code>依赖装上以后报错<code>Cannot read property &#39;DocumentDir&#39; of undefined</code>？<br>A:<code>rn-fetch-blob</code>版本需要是<code>&quot;0.10.15&quot;</code>,否则不兼容 android。</p>
</li>
<li><p>Q:NetWork 里看不到请求？<br>A:<code>rn-fetch-blob</code> 的文件请求走的不是 netWork，所以在 netWork 里是看不到请求的，可以用 <code>console.log</code> 的方式查看请求。</p>
</li>
</ul>
<h3 id="IOS-端权限兼容"><a href="#IOS-端权限兼容" class="headerlink" title="IOS 端权限兼容"></a>IOS 端权限兼容</h3><p>&emsp;&emsp;最后是 IOS 端的权限兼容，因为 ios 的 APP 会限制照片，照相，存照片的权限，如果什么都不做就会报<code>Thread x: signal SIGABRT</code>的错误，导致 APP 闪退卡死。<br>&emsp;&emsp;所以需要在项目的<code>ios/项目名称</code>文件夹中找到<code>Info.plist</code>文件，在最后加上三个 <code>key</code> 和对应的信息 <code>string</code>:</p>
<pre><code class="javascript">  &lt;key&gt;NSPhotoLibraryAddUsageDescription&lt;/key&gt;
    &lt;string&gt;请允许APP保存图片到相册&lt;/string&gt;
    &lt;key&gt;NSPhotoLibraryUsageDescription&lt;/key&gt;
    &lt;string&gt;请允许APP访问您的相册&lt;/string&gt;
    &lt;key&gt;NSCameraUsageDescription&lt;/key&gt;
    &lt;string&gt;请允许APP访问您的相机&lt;/string&gt;</code></pre>
<p>问题解决完以后，最后实现效果如下:<br><img src="/images/posts/rnImagePicker/ios-result.jpg" alt="ios实现效果"></p>
<p><img src="/images/posts/rnImagePicker/android-result.jpg" alt="安卓实现效果"></p>

  </article>
  
    
<div class="nexmoe-post-copyright">
<i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
<strong>本文作者：</strong>Ruan XuSong<br>
<strong>本文链接：</strong><a href="https://www.ruanxusong.com/2020/01/23/rnImagePicker/" title="https:&#x2F;&#x2F;www.ruanxusong.com&#x2F;2020&#x2F;01&#x2F;23&#x2F;rnImagePicker&#x2F;" target="_blank" rel="noopener">https:&#x2F;&#x2F;www.ruanxusong.com&#x2F;2020&#x2F;01&#x2F;23&#x2F;rnImagePicker&#x2F;</a><br>

  <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可

</div>


  
  <section class="nexmoe-comment">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.css" />
<div id="gitalk"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.5.0/dist/gitalk.min.js"></script>
<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: "c42de8657e362551bd3e",
    clientSecret: "d9fb1325c3fefa35a2486369919f7e4ee16cdc33",
    id: window.location.pathname,
    repo: "ruanxusong.github.io",
    owner: "RuanXuSong",
    admin: "RuanXuSong"
  });
  gitalk.render("gitalk");
</script>

</section>
</div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/mdui@0.4.3/dist/js/mdui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>

<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
 
<script src="https://cdn.jsdelivr.net/npm/smoothscroll-for-websites@1.4.9/SmoothScroll.min.js"></script>


<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.8/build/highlight.min.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
<script></script>

<script src="/js/app.js?v=1579758438475"></script>
<script src="https://cdn.jsdelivr.net/npm/lazysizes@5.1.0/lazysizes.min.js"></script>


<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/xtaodada/xtaodada.github.io@0.0.2/copy.js"></script>
 
 





  <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body>
</html>
